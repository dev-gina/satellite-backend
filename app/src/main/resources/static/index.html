<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìœ„ì„± ì˜ìƒ ì²˜ë¦¬ ì„œë¹„ìŠ¤</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <div class="container">
    <h1>ìœ„ì„± ì˜ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ - ì´ì§„ì•„</h1>

    <section>
      <h2>1. íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</h2>
      <button id="listFilesBtn">S3ì—ì„œ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°</button>
      <p id="selectedCount">ì„ íƒëœ íŒŒì¼: 0ê°œ</p>
      <div id="fileCheckboxList"></div>
    </section>

    <section>
      <h2>2. ì‘ì—… ìˆ˜í–‰</h2>
      <button id="saveMetadataBtn">ë©”íƒ€ë°ì´í„° ì €ì¥</button>
      <button id="convertCogBtn">COG ë³€í™˜</button>
      <button id="uploadResultBtn">ë³€í™˜ + ì—…ë¡œë“œ</button>
    </section>

    <section>
      <h2>3. ê²°ê³¼</h2>
      <pre id="resultLog"></pre>
    </section>
  </div>

  <script>
    const apiUrl = 'http://localhost:8080';

    function appendLog(message) {
      const log = document.getElementById('resultLog');
      log.textContent += `\n${message}`;
    }

    // ì²´í¬ë°•ìŠ¤ë¡œ íŒŒì¼ ëª©ë¡ ê·¸ë ¤ì£¼ê¸°
    function renderCheckboxFileList(fileList) {
      const container = document.getElementById('fileCheckboxList');
      container.innerHTML = '';
      document.getElementById('selectedCount').textContent = 'ì„ íƒëœ íŒŒì¼: 0ê°œ';

      fileList.forEach(file => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = file.name;
        checkbox.addEventListener('change', updateSelectedCount);

        const label = document.createElement('label');
        label.className = 'file-checkbox-item';

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(` ${file.name}`));
        container.appendChild(label);
      });
    }

    function updateSelectedCount() {
      const count = document.querySelectorAll('#fileCheckboxList input[type="checkbox"]:checked').length;
      document.getElementById('selectedCount').textContent = `ì„ íƒëœ íŒŒì¼: ${count}ê°œ`;
    }

    // ì„ íƒëœ íŒŒì¼ ì´ë¦„ ë°°ì—´ë¡œ ê°€ì ¸ì˜¤ê¸°
    function getSelectedFiles() {
      const checkboxes = document.querySelectorAll('#fileCheckboxList input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    // íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    document.getElementById('listFilesBtn').addEventListener('click', function() {

      fetch(`${apiUrl}/satellite-images/source-list`)
        .then(response => response.json())
        .then(fileList => {
          renderCheckboxFileList(fileList); 
          appendLog("íŒŒì¼ ëª©ë¡ ë¡œë“œ ì™„ë£Œ");
        })
        .catch(() => {
          appendLog("íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨");
        });
    });

    // ë©”íƒ€ë°ì´í„° ì €ì¥
    document.getElementById('saveMetadataBtn').addEventListener('click', async function() {
      const selectedFiles = getSelectedFiles();
      if (selectedFiles.length === 0) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');

      for (const fileName of selectedFiles) {

        const response = await fetch(`${apiUrl}/satellite-images/metadata`, {
          method: 'POST',
          body: JSON.stringify({ name: fileName }),
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          appendLog(`ë©”íƒ€ë°ì´í„° ì €ì¥ ì™„ë£Œ: ${fileName}`);
        } else {
          appendLog(`ë©”íƒ€ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: ${fileName}`);
        }
      }
    });

    // COG ë³€í™˜
    document.getElementById('convertCogBtn').addEventListener('click', async function() {
      const selectedFiles = getSelectedFiles();
      if (selectedFiles.length === 0) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');

      for (const fileName of selectedFiles) {
          appendLog(`COG ë³€í™˜ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”ğŸ˜ (${fileName})`);
          await new Promise(r => setTimeout(r, 100));

          const response = await fetch(`${apiUrl}/satellite-images/convert`, {
            method: 'POST',
            body: JSON.stringify({ name: fileName }),
            headers: { 'Content-Type': 'application/json' }
          });

          if (response.ok) {
            appendLog(`COG ë³€í™˜ ì™„ë£Œ: ${fileName}`);
          } else {
            appendLog(`COG ë³€í™˜ ì‹¤íŒ¨: ${fileName}`);
          }
        }
    });

    // ë³€í™˜ + ì—…ë¡œë“œ (ìë™)
    document.getElementById('uploadResultBtn').addEventListener('click', async function () {
    const selectedFiles = getSelectedFiles();
    if (selectedFiles.length === 0) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');

    for (const fileName of selectedFiles) {
      // 1. ì—…ë¡œë“œ ì¤‘ ë©”ì‹œì§€ ë¨¼ì € ì¶œë ¥
      appendLog(`ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”ğŸ˜ (${fileName})`);
      await new Promise(r => setTimeout(r, 100)); // ë Œë”ë§ ì‹œê°„ í™•ë³´

      // 2. ë³€í™˜ ìš”ì²­
      const convertRes = await fetch(`${apiUrl}/satellite-images/convert`, {
        method: 'POST',
        body: JSON.stringify({ name: fileName }),
        headers: { 'Content-Type': 'application/json' }
      });

      if (!convertRes.ok) {
        appendLog(`COG ë³€í™˜ ì‹¤íŒ¨: ${fileName}`);
        continue;
      }

      // 3. ì—…ë¡œë“œ ìš”ì²­
      const uploadRes = await fetch(`${apiUrl}/satellite-images/upload`, {
        method: 'POST',
        body: JSON.stringify({ name: fileName }),
        headers: { 'Content-Type': 'application/json' }
      });

      // 4. ê²°ê³¼ ì¶œë ¥
      if (uploadRes.ok) {
        appendLog(`ì—…ë¡œë“œ ì™„ë£Œ: ${fileName}`);
      } else {
        appendLog(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${fileName}`);
      }
    }
  });

  </script>
</body>
</html>
